var e=null;const t=/mobile/i.test(window.navigator.userAgent);const a=function(a,n){var r={type:"audio",mode:"random",btns:["play-pause","music"],controls:["mode","backward","play-pause","forward","volume"],events:{"play-pause":function(e){if(s.paused){a.player.play()}else{a.player.pause()}},music:function(e){if(o.el.hasClass("show")){o.hide()}else{o.el.addClass("show");l.scroll().title()}}}},i={random:function(e){return Math.floor(Math.random()*e)},parse:function(e){var t=[];[["music.163.com.*song.*id=(\\d+)","netease","song"],["music.163.com.*album.*id=(\\d+)","netease","album"],["music.163.com.*artist.*id=(\\d+)","netease","artist"],["music.163.com.*playlist.*id=(\\d+)","netease","playlist"],["music.163.com.*discover/toplist.*id=(\\d+)","netease","playlist"],["y.qq.com.*song/(\\w+).html","tencent","song"],["y.qq.com.*album/(\\w+).html","tencent","album"],["y.qq.com.*singer/(\\w+).html","tencent","artist"],["y.qq.com.*playsquare/(\\w+).html","tencent","playlist"],["y.qq.com.*playlist/(\\w+).html","tencent","playlist"],["xiami.com.*song/(\\w+)","xiami","song"],["xiami.com.*album/(\\w+)","xiami","album"],["xiami.com.*artist/(\\w+)","xiami","artist"],["xiami.com.*collect/(\\w+)","xiami","playlist"]].forEach(function(a){var n=new RegExp(a[0]);var r=n.exec(e);if(r!==null){t=[a[1],a[2],r[1]]}});return t},fetch:function(e){var t=[];return new Promise(function(a,n){e.forEach(function(e){var n=i.parse(e);if(n[0]){var r=JSON.stringify(n);var s=store.get(r);if(s){t.push.apply(t,JSON.parse(s));a(t)}else{fetch("https://api.i-meto.com/meting/api?server="+n[0]+"&type="+n[1]+"&id="+n[2]+"&r="+Math.random()).then(function(e){return e.json()}).then(function(e){store.set(r,JSON.stringify(e));t.push.apply(t,e);a(t)}).catch(function(e){})}}else{t.push(e);a(t)}})})},secondToTime:function(e){var t=function(e){return isNaN(e)?"00":e<10?"0"+e:""+e};var a=Math.floor(e/3600);var n=Math.floor((e-a*3600)/60);var r=Math.floor(e-a*3600-n*60);return(a>0?[a,n,r]:[n,r]).map(t).join(":")},nameMap:{dragStart:t?"touchstart":"mousedown",dragMove:t?"touchmove":"mousemove",dragEnd:t?"touchend":"mouseup"}},s=null;a.player={_id:i.random(999999),group:true,load:function(e){var t="";var a=this;if(e&&e.length>0){if(this.options.rawList!==e){this.options.rawList=e;l.clear()}}else{t="none";this.pause()}for(var n in f.el){f.el[n].display(t)}return this},fetch:function(){var e=this;return new Promise(function(t,a){if(l.data.length>0){t()}else{if(e.options.rawList){var n=[];e.options.rawList.forEach(function(t,a){n.push(new Promise(function(n,r){var s=a;var o;if(!t.list){s=0;e.group=false;o=[t]}else{e.group=true;o=t.list}i.fetch(o).then(function(e){l.add(s,e);n()})}))});Promise.all(n).then(function(){t(true)})}}}).then(function(t){if(t){l.create();p.create();e.mode()}})},mode:function(){var e=l.data.length;if(!e||l.errnum==e)return;var t=p.step=="next"?1:-1;var a=function(){var a=l.index+t;if(a>e||a<0){a=p.step=="next"?0:e-1}l.index=a};var n=function(){var t=i.random(e);if(l.index!==t){l.index=t}else{a()}};switch(this.options.mode){case"random":n();break;case"order":a();break;case"loop":if(p.step)a();if(l.index==-1)n();break}this.init()},"switch":function(e){if(typeof e=="number"&&e!=l.index&&l.current()&&!l.current().error){l.index=e;this.init()}},init:function(){var e=l.current();if(!e||e["error"]){this.mode();return}var t=false;if(!s.paused){t=true;this.stop()}s.attr("src",e.url);s.attr("title",e.name+" - "+e.artist);this.volume(store.get("_PlayerVolume")||"0.7");this.muted(store.get("_PlayerMuted"));u.create();if(this.options.type=="audio")d.create();if(t==true){this.play()}},play:function(){e&&e.player.pause();if(l.current().error){this.mode();return}var t=this;s.play().then(function(){l.scroll()}).catch(function(e){})},pause:function(){s.pause();document.title=originTitle},stop:function(){s.pause();s.currentTime=0;document.title=originTitle},seek:function(e){e=Math.max(e,0);e=Math.min(e,s.duration);s.currentTime=e;u.update(e/s.duration)},muted:function(e){if(e=="muted"){s.muted=e;store.set("_PlayerMuted",e);p.update(0)}else{store.del("_PlayerMuted");s.muted=false;p.update(s.volume)}},volume:function(e){if(!isNaN(e)){p.update(e);store.set("_PlayerVolume",e);s.volume=e}},mini:function(){o.hide()}};var o={el:null,create:function(){if(this.el)return;this.el=a.createChild("div",{className:"player-info",innerHTML:(a.player.options.type=="audio"?'<div class="preview"></div>':"")+'<div class="controller"></div><div class="playlist"></div>'},"after");d.el=this.el.child(".preview");l.el=this.el.child(".playlist");p.el=this.el.child(".controller")},hide:function(){var e=this.el;e.addClass("hide");window.setTimeout(function(){e.removeClass("show hide")},300)}};var l={el:null,data:[],index:-1,errnum:0,add:function(e,t){var a=this;t.forEach(function(t,n){t.group=e;t.name=t.name||t.title||"Meida name";t.artist=t.artist||t.author||"Anonymous";t.cover=t.cover||t.pic;t.type=t.type||"normal";a.data.push(t)})},clear:function(){this.data=[];this.el.innerHTML="";if(this.index!==-1){this.index=-1;a.player.fetch()}},create:function(){var e=this.el;this.data.map(function(t,n){if(t.el)return;var r="list-"+a.player._id+"-"+t.group;var i=$("#"+r);if(!i){i=e.createChild("div",{id:r,className:a.player.group?"tab":"",innerHTML:"<ol></ol>"});if(a.player.group){i.attr("data-title",a.player.options.rawList[t.group]["title"]).attr("data-id",a.player._id)}}t.el=i.child("ol").createChild("li",{title:t.name+" - "+t.artist,innerHTML:'<span class="info"><span>'+t.name+"</span><span>"+t.artist+"</span></span>",onclick:function(e){var t=e.currentTarget;if(l.index===n&&u.el){if(s.paused){a.player.play()}else{a.player.seek(s.duration*u.percent(e,t))}return}a.player.switch(n);a.player.play()}});return t});tabFormat()},current:function(){return this.data[this.index]},scroll:function(){var e=this.current();var t=this.el.child("li.active");t&&t.removeClass("active");var a=this.el.child(".tab.active");a&&a.removeClass("active");t=this.el.find(".nav li")[e.group];t&&t.addClass("active");a=this.el.find(".tab")[e.group];a&&a.addClass("active");pageScroll(e.el,e.el.offsetTop);return this},title:function(){if(s.paused)return;var e=this.current();document.title="Now Playing..."+e["name"]+" - "+e["artist"]+" | "+originTitle},error:function(){var e=this.current();e.el.removeClass("current").addClass("error");e.error=true;this.errnum++}};var c={el:null,data:null,index:0,create:function(e){var t=l.index;var a=this;var n=l.current().lrc;var r=function(n){if(t!==l.index)return;a.data=a.parse(n);var r="";a.data.forEach(function(e,t){r+="<p"+(t===0?' class="current"':"")+">"+e[1]+"</p>"});a.el=e.createChild("div",{className:"inner",innerHTML:r},"replace");a.index=0};if(n.startsWith("http"))this.fetch(n,r);else r(n)},update:function(e){if(!this.data)return;if(this.index>this.data.length-1||e<this.data[this.index][0]||(!this.data[this.index+1]||e>=this.data[this.index+1][0])){for(var t=0;t<this.data.length;t++){if(e>=this.data[t][0]&&(!this.data[t+1]||e<this.data[t+1][0])){this.index=t;var a=-(this.index-1);this.el.style.transform="translateY("+a+"rem)";this.el.style.webkitTransform="translateY("+a+"rem)";this.el.getElementsByClassName("current")[0].removeClass("current");this.el.getElementsByTagName("p")[t].addClass("current")}}}},parse:function(e){if(e){e=e.replace(/([^\]^\n])\[/g,function(e,t){return t+"\n["});const t=e.split("\n");var a=[];const n=t.length;for(var r=0;r<n;r++){const i=t[r].match(/\[(\d{2}):(\d{2})(\.(\d{2,3}))?]/g);const s=t[r].replace(/.*\[(\d{2}):(\d{2})(\.(\d{2,3}))?]/g,"").replace(/<(\d{2}):(\d{2})(\.(\d{2,3}))?>/g,"").replace(/^\s+|\s+$/g,"");if(i){const o=i.length;for(var l=0;l<o;l++){const c=/\[(\d{2}):(\d{2})(\.(\d{2,3}))?]/.exec(i[l]);const d=c[1]*60;const u=parseInt(c[2]);const p=c[4]?parseInt(c[4])/((c[4]+"").length===2?100:1e3):0;const m=d+u+p;a.push([m,s])}}}a=a.filter(function(e){return e[1]});a.sort(function(e,t){return e[0]-t[0]});return a}else{return[]}},fetch:function(e,t){fetch(e).then(function(e){return e.text()}).then(function(e){t(e)}).catch(function(e){})}};var d={el:null,create:function(){var e=l.current();this.el.innerHTML='<div class="cover"><div class="disc"><img src="'+e.cover+'" class="blur" /></div></div>'+'<div class="info"><h4 class="title">'+e.name+"</h4><span>"+e.artist+"</span>"+'<div class="lrc"></div></div>';this.el.child(".cover").addEventListener("click",a.player.options.events["play-pause"]);c.create(this.el.child(".lrc"))}};var u={el:null,bar:null,create:function(){var e=l.current().el;if(e){if(this.el){this.el.parentNode.removeClass("current").removeEventListener(i.nameMap.dragStart,this.drag);this.el.remove()}this.el=e.createChild("div",{className:"progress"});this.el.attr("data-dtime",i.secondToTime(0));this.bar=this.el.createChild("div",{className:"bar"});e.addClass("current");e.addEventListener(i.nameMap.dragStart,this.drag);l.scroll()}},update:function(e){this.bar.width(Math.floor(e*100)+"%");this.el.attr("data-ptime",i.secondToTime(e*s.duration))},seeking:function(e){if(e)this.el.addClass("seeking");else this.el.removeClass("seeking")},percent:function(e,t){var a=((e.clientX||e.changedTouches[0].clientX)-t.left())/t.width();a=Math.max(a,0);return Math.min(a,1)},drag:function(e){e.preventDefault();var t=l.current().el;var n=function(e){e.preventDefault();var a=u.percent(e,t);u.update(a);c.update(a*s.duration)};var r=function(e){e.preventDefault();t.removeEventListener(i.nameMap.dragEnd,r);t.removeEventListener(i.nameMap.dragMove,n);var o=u.percent(e,t);u.update(o);a.player.seek(o*s.duration);s.disableTimeupdate=false;u.seeking(false)};s.disableTimeupdate=true;u.seeking(true);t.addEventListener(i.nameMap.dragMove,n);t.addEventListener(i.nameMap.dragEnd,r)}};var p={el:null,btns:{},step:"next",create:function(){if(!a.player.options.controls)return;var e=this;a.player.options.controls.forEach(function(t){if(e.btns[t])return;var n={onclick:function(n){e.events[t]?e.events[t](n):a.player.options.events[t](n)}};switch(t){case"volume":n.className=" "+(s.muted?"off":"on");n.innerHTML='<div class="bar"></div>';n["on"+i.nameMap.dragStart]=e.events["volume"];n.onclick=null;break;case"mode":n.className=" "+a.player.options.mode;break;default:n.className="";break}n.className=t+n.className+" btn";e.btns[t]=e.el.createChild("div",n)});e.btns["volume"].bar=e.btns["volume"].child(".bar")},events:{mode:function(e){switch(a.player.options.mode){case"loop":a.player.options.mode="random";break;case"random":a.player.options.mode="order";break;default:a.player.options.mode="loop"}p.btns["mode"].className="mode "+a.player.options.mode+" btn";store.set("_PlayerMode",a.player.options.mode)},volume:function(e){e.preventDefault();var t=e.currentTarget;var n=false;var r=function(e){e.preventDefault();a.player.volume(p.percent(e,t));n=true};var o=function(e){e.preventDefault();t.removeEventListener(i.nameMap.dragEnd,o);t.removeEventListener(i.nameMap.dragMove,r);if(n){a.player.muted();a.player.volume(p.percent(e,t))}else{if(s.muted){a.player.muted();a.player.volume(s.volume)}else{a.player.muted("muted");p.update(0)}}};t.addEventListener(i.nameMap.dragMove,r);t.addEventListener(i.nameMap.dragEnd,o)},backward:function(e){p.step="prev";a.player.mode()},forward:function(e){p.step="next";a.player.mode()}},update:function(e){p.btns["volume"].className="volume "+(!s.muted&&e>0?"on":"off")+" btn";p.btns["volume"].bar.width(Math.floor(e*100)+"%")},percent:function(e,t){var a=((e.clientX||e.changedTouches[0].clientX)-t.left())/t.width();a=Math.max(a,0);return Math.min(a,1)}};var m={onerror:function(){l.error();a.player.mode()},ondurationchange:function(){if(s.duration!==1){u.el.attr("data-dtime",i.secondToTime(s.duration))}},onloadedmetadata:function(){a.player.seek(0);u.el.attr("data-dtime",i.secondToTime(s.duration))},onplay:function(){a.parentNode.addClass("playing");showtip(this.attr("title"));e=a},onpause:function(){a.parentNode.removeClass("playing");e=null},ontimeupdate:function(){if(!this.disableTimeupdate){u.update(this.currentTime/this.duration);c.update(this.currentTime)}},onended:function(e){a.player.mode();a.player.play()}};var f={el:{},create:function(){if(!a.player.options.btns)return;var e=this;a.player.options.btns.forEach(function(t){if(e.el[t])return;e.el[t]=a.createChild("div",{className:t+" btn",onclick:function(e){a.player.fetch().then(function(){a.player.options.events[t](e)})}})})}};var h=function(e){if(a.player.created)return;a.player.options=Object.assign(r,e);a.player.options.mode=store.get("_PlayerMode")||a.player.options.mode;f.create();s=a.createChild(a.player.options.type,m);o.create();a.parentNode.addClass(a.player.options.type);a.player.created=true};h(n);return a};